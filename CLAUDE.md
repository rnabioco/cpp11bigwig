# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working
with code in this repository.

## Package Overview

cpp11bigwig is an R package providing read-only access to bigWig and
bigBed genomic data files. It wraps the libBigWig C library (v0.4.8,
vendored in src/libBigWig/) using cpp11 for R/C++ integration.

## Build Commands

``` bash
# Install package dependencies
R -e "install.packages(c('cpp11', 'tibble', 'testthat'))"
R -e "BiocManager::install(c('GenomicRanges', 'IRanges'))"

# Load package during development
R -e "devtools::load_all()"

# Run all tests
R -e "devtools::test()"

# Run a single test file
R -e "testthat::test_file('tests/testthat/test-read.R')"

# Full package check
R -e "devtools::check()"

# Rebuild C++ wrappers after modifying cpp11bigwig.cpp
R -e "cpp11::cpp_register()"

# Rebuild libBigWig manually (rarely needed)
cd src/libBigWig && make clean && make
```

## Architecture

### C++ Layer (src/)

- `cpp11bigwig.cpp` - Core implementation with three registered
  functions:
  - `read_bigwig_cpp()` - Reads bigWig intervals, merges consecutive
    intervals with same values
  - `read_bigbed_cpp()` - Reads bigBed entries with preserved end
    coordinates
  - `bigbed_sql_cpp()` - Extracts autoSql schema from bigBed files
- `cpp11.cpp` - Auto-generated by cpp11::cpp_register() - **never edit
  manually**
- `libBigWig/` - Vendored C library compiled as static library
  (libBigWig.a)

### R Layer (R/)

- `read.r` - Exported functions
  [`read_bigwig()`](https://rnabioco.github.io/cpp11bigwig/reference/read_bigwig.md)
  and
  [`read_bigbed()`](https://rnabioco.github.io/cpp11bigwig/reference/read_bigbed.md)
  with input validation and output formatting
- `cpp11.R` - Auto-generated .Call wrappers - **never edit manually**

### Build System

- `src/Makevars` triggers libBigWig compilation before package
  compilation
- libBigWig compiled with `-O3 -DNOCURL -fpic` (no remote file support)

## Key Implementation Details

- bigWig reader merges consecutive intervals with identical values
- bigBed reader preserves actual genomic coordinates (end is not +1
  adjusted)
- Functions return tibbles by default, optionally GRanges objects (via
  `as="GRanges"`)
- All C++ functions use `[[cpp11::register]]` attribute for automatic
  wrapper generation
- libBigWig structures require proper cleanup:
  `bwDestroyOverlappingIntervals()`, `bwClose()`

## Testing

Uses testthat edition 3 with snapshot testing for error messages. Test
data in `inst/extdata/` (test.bw, test.bb, test.bg).
